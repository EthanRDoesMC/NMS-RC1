<!-- High Dynamic Range (HDR) utf-8Shading Pipeline -->
<Pipeline>
  <Setup>

    <RenderTarget id="SHADOWBUF"   depthBuf="true"  numColBufs="0"  format="RGBA8" scale="1.0" width="5376" height="1792" maxSamples="0" shadow="true" hasMips="false" numUniformBuffers="3"/>

    <RenderTarget id="GBUFFER"     depthBuf="false" numColBufs="4"  format0="RGBA8" format1="RED32F" format2="RGB10A2" format3="RGBA8" scale="1.0" maxSamples="0" pointSampleColBuf1="true" pointSampleColBuf2="true" pointSampleColBuf3="true" />
    <!-- <RenderTarget id="HDRBUF_0"    depthBuf="false" numColBufs="1"  format="R11FG11FB10F" scale="1.0" maxSamples="0" /> -->
    <RenderTarget id="HDRBUF_1"    depthBuf="false" numColBufs="1"  format="R11FG11FB10F" scale="1.0" maxSamples="0" />

     <!-- <RenderTarget id="FINAL"       depthBuf="false" numColBufs="1"  format="RGBA8" scale="1.0" maxSamples="0" /> -->
    
    <RenderTarget id="VOLUME"      depthBuf="false" numColBufs="1"  format="RGBA16F" scale="0.5" maxSamples="0" pointSampleColBuf0="true"/>
    <RenderTarget id="BLUR1"       depthBuf="false"  numColBufs="1"  format="RGBA16F" scale="0.5" maxSamples="0" pointSampleColBuf0="true"/>
    <!-- <RenderTarget id="BLUR2"       depthBuf="true"  numColBufs="1"  format="RGBA16F" scale="0.25" maxSamples="0"/> -->

    <RenderTarget id="DEPTH"       depthBuf="true"   numColBufs="0"  format="RGBA8" scale="1.0" maxSamples="0" stencilBuf="true" />
    <!-- <RenderTarget id="DEPTH_COPY"  depthBuf="true"   numColBufs="0"  format="RGBA16F" scale="1.0" maxSamples="0" stencilBuf="true" />  -->
    <RenderTarget id="DEPTH_DOWN"  depthBuf="false"  numColBufs="1"  format="RED32F"   scale="0.5" maxSamples="0" pointSampleColBuf0="true" />

    <RenderTarget id="CLOUDS"         depthBuf="true"  numColBufs="1" format="RGBA8" bilinear="true" scale="0.125" />
    <RenderTarget id="CLOUDSHADOWS"   depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="1.0" width="1024" height="1024" />

    <RenderTarget id="PARTICLES"      depthBuf="false" numColBufs="1" format="RGBA16F" bilinear="true" scale="0.5" />

    <!--  <RenderTarget id="DOF_TONEMAP"    depthBuf="false" numColBufs="1" format="RGBA8" scale="1.0" maxSamples="0" /> -->
    <RenderTarget id="DOF_BLURBUF1"   depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="0.5" />
    <RenderTarget id="DOF_BLURBUF2"   depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="0.5" />

    <!-- <RenderTarget id="BRIGHTPASS"     depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="1.0" />   -->
    <RenderTarget id="BLOOM_BLURBUF1" depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="0.25" />
    <RenderTarget id="BLOOM_BLURBUF2" depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="0.25" />
    <RenderTarget id="BLOOM_BLURBUF3" depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="0.25" />
    <RenderTarget id="BLOOM_BLURBUF4" depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="0.25" />
    
    <!--<RenderTarget id="BLOOM_BLURBUF_2xA"  depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="0.25" />
    <RenderTarget id="BLOOM_BLURBUF_2xB"  depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="0.25" />
    <RenderTarget id="BLOOM_BLURBUF_4xA"  depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="0.25" />
    <RenderTarget id="BLOOM_BLURBUF_4xB"  depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="0.25" />
    <RenderTarget id="BLOOM_BLURBUF_8xA"  depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="0.125" />
    <RenderTarget id="BLOOM_BLURBUF_8xB"  depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="0.125" />
    <RenderTarget id="BLOOM_BLURBUF_16xA" depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="0.0625" />
    <RenderTarget id="BLOOM_BLURBUF_16xB" depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="0.0625" />-->

    <RenderTarget id="LENS_BLURBUF"   depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="0.25" />
    <RenderTarget id="LENSFLAREBUF"   depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="0.25" />
     <!-- <RenderTarget id="LENSFINAL"      depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="1.0"/> -->
    
     <!-- <RenderTarget id="UI_COMBINE_BUF" depthBuf="false" numColBufs="1" format="RGBA8" bilinear="true" scale="1.0" /> -->

     <RenderTarget id="FINAL_OR_DOF_TONEMAP"    depthBuf="false" numColBufs="1" format="RGBA8" scale="1.0" maxSamples="0" />
     <RenderTarget id="LENSFINAL_OR_UI_COMBINE_BUF"     depthBuf="false" numColBufs="1" format="RGBA8"  bilinear="true" scale="1.0"/>

    
  </Setup>

  <!-- Scene rendering -->
  <CommandQueue>

    <Stage id="Shadow">
      
      <BeginTarget target="SHADOWBUF" />

      <UpdateShadowMap />
      
      <ColourMask channels="RGBA"/>
      <ClearTarget depthBuf="true" colBuf0="false" excludeX360="false" col_R="0.0" col_G="0.0" col_B="0.0" col_A="0.0" />
      <!--PS4: default setting after ClearTarget equals RT0-RGBA, so no need to call ColourMask again-->
      
      <!--PS4: we're using HTile but not allowing compression, to save decompressing the very large shadowmap target at the end -->
      
      <SetDepthBufferControl allowCompression="false" />
      <SetShadowMap index="0" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" />
      <DrawShadowGeometry type="Mesh"         class="Glow"           context="SHADOW"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Opaque"         context="SHADOW"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Cutout"         context="SHADOW"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Highlight"      context="SHADOW"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="ShadowOnly"     context="SHADOW"            order="STATECHANGES"/>
      <DrawShadowGeometry type="InstanceMesh" class="Opaque"         context="SHADOW_INSTANCE"   order="STATECHANGES"/>
      <DrawShadowGeometry type="InstanceMesh" class="Cutout"         context="SHADOW_INSTANCE"   order="STATECHANGES"/>
      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="lessEqual" />
      <DrawShadowGeometry type="Mesh"         class="DoubleSided"             context="SHADOW"            order="STATECHANGES" />
      <DrawShadowGeometry type="InstanceMesh" class="DoubleSided"             context="SHADOW_INSTANCE"   order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="HighlightDoubleSided"    context="SHADOW"            order="STATECHANGES" />

      <SetShadowMap index="1" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="1" />
      <DrawShadowGeometry type="Mesh"         class="Glow"           context="SHADOW"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Opaque"         context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="Cutout"         context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="Highlight"      context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="ShadowOnly"     context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="InstanceMesh" class="Opaque"         context="SHADOW_INSTANCE_FADE"   order="STATECHANGES" />
      <DrawShadowGeometry type="InstanceMesh" class="Cutout"         context="SHADOW_INSTANCE_FADE"   order="STATECHANGES" />
      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="1" />
      <DrawShadowGeometry type="Mesh"         class="DoubleSided"             context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="InstanceMesh" class="DoubleSided"             context="SHADOW_INSTANCE_FADE"   order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="HighlightDoubleSided"    context="SHADOW_FADE"            order="STATECHANGES" />

      <SetShadowMap index="2" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="2" />
      <DrawShadowGeometry type="Mesh"         class="Glow"           context="SHADOW"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Opaque"         context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="Cutout"         context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="Highlight"      context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="ShadowOnly"     context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="InstanceMesh" class="Opaque"         context="SHADOW_INSTANCE_FADE"   order="STATECHANGES" />
      <DrawShadowGeometry type="InstanceMesh" class="Cutout"         context="SHADOW_INSTANCE_FADE"   order="STATECHANGES" />
      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="2"  />
      <DrawShadowGeometry type="Mesh"         class="DoubleSided"             context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="InstanceMesh" class="DoubleSided"             context="SHADOW_INSTANCE_FADE"   order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="HighlightDoubleSided"    context="SHADOW_FADE"            order="STATECHANGES" />
      
      
      <SetShadowMap index="0" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" />      
      <DrawShadowGeometry type="Terrain"      class="LOD0"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Terrain"      class="LOD1"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Terrain"      class="LOD2"           context="SHADOW_FADE"            order="STATECHANGES"/>      
      <SetShadowMap index="1" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="1" />      
      <DrawShadowGeometry type="Terrain"      class="LOD0"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Terrain"      class="LOD1"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Terrain"      class="LOD2"           context="SHADOW_FADE"            order="STATECHANGES"/>      
      <SetShadowMap index="2" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="2" />      
      <DrawShadowGeometry type="Terrain"      class="LOD0"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Terrain"      class="LOD1"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Terrain"      class="LOD2"           context="SHADOW_FADE"            order="STATECHANGES"/>      
      
      <SetShadowMap index="-1" />

      <SetDepthBufferControl allowCompression="true" />    
      <EndTarget flushCB="false" flushDB="true" />
    
    </Stage>

    <Stage id="CloudShadows">    
      <BeginTarget target="CLOUDSHADOWS" />
      <ColourMask channels="RGBA"/> 
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="Materials/Cloud.material.mbin" context="RENDER2D" width ="1.0" height="1.0" />
      <EndTarget flushCB="true" flushDB="false" />
      <UnbindBuffers />
    </Stage>

    <Stage id="Attributes">

      <BeginTarget target="GBUFFER" depthTarget="DEPTH" />

      <ColourMask channels="RGBA"/>
      <!-- Clear targets, colbuf1 is cleared separately to max depth -->
      <ClearTarget colBuf0="true"  colBuf1="false" colBuf2="true"  colBuf3="true"  depthBuf="true"   stencilBuf="true" />
      <!-- <ClearTarget colBuf0="false"  colBuf1="false" colBuf2="false"  colBuf3="false"  depthBuf="true"   stencilBuf="true" /> -->
      <ClearTarget colBuf0="false"  colBuf1="true" colBuf2="false" colBuf3="false" depthBuf="false"  stencilBuf="false"  col_R="1.0" col_G="1.0" col_B="1.0" col_A="1.0" />
      <ColourMask channels="RGBA"/> <!--Enable all attached RTs, since ClearTarget only (re-)enables RT0 on PS4-->

      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />

      <!-- Z Pre-Pass for Cutout (grass etc) -->
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite"/>/>
      <DrawGeometry type="InstanceMesh" class="Cutout"    context="DEPTHONLY_DEFER_INSTANCE"    order="" />      
      <!-- <DrawGeometry type="Terrain"      class="LOD0"      context="DEPTHONLY_DEFER"             order="" /> !-->
      <!-- Opaques-->
      <ColourMask channels="RGBA"/> <!--Enable all attached RTs, since ClearTarget only (re-)enables RT0 on PS4-->
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite"/>
      <DrawGeometry type="Mesh"         class="Opaque"    context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="Highlight" context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="Cutout"    context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="InstanceMesh" class="Opaque"    context="LIT_DEFER_INSTANCE"    order="STATECHANGES" />


      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" stencilMode="maskWrite"/>
      <DrawGeometry type="Mesh"         class="DoubleSided"             context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="InstanceMesh" class="DoubleSided"             context="LIT_DEFER_INSTANCE"    order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="HighlightDoubleSided"    context="LIT_DEFER"             order="STATECHANGES" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="equal" stencilMode="disabled"/>
      <DrawGeometry type="InstanceMesh" class="Cutout"    context="LIT_DEFER_INSTANCE"    order="" />      
      <!-- <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER"             order="FRONT_TO_BACK" /> -->
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite"/>      
      
      <DrawGeometry type="Mesh"         class="Glow"      context="LIT_DEFER"             order="STATECHANGES" />    
      <DrawGeometry type="InstanceMesh" class="Glow"      context="LIT_DEFER_INSTANCE"    order="STATECHANGES" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER"             order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD1"      context="LIT_DEFER"             order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD2"      context="LIT_DEFER"             order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD3"      context="LIT_DEFER"             order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="PLANET"    context="LIT_DEFER_LOW"         order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="ASTEROID"  context="LIT_DEFER_ASTEROID"    order="STATECHANGES" />
           
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="always" />
      <DrawGeometry type="Mesh"         class="GunOpaque"    context="DEPTH_CLEAR"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="GunGlow"      context="DEPTH_CLEAR"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="GunDecal"     context="DEPTH_CLEAR"             order="STATECHANGES"  /> <!-- These aren't real decals, they are just meshes with 2 UV sets which is why they are still rendered here. -->

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="3"/>
      <DrawGeometry type="Mesh"         class="GunOpaque"    context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="GunGlow"      context="LIT_DEFER"             order="STATECHANGES" />    
      <DrawGeometry type="Mesh"         class="GunDecal"     context="LIT_DEFER"             order="STATECHANGES"  />
    
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="Decals">

      <BeginTarget target="GBUFFER" depthTarget="" />
      <BindBuffer sampler="gBufferMap"   sourceRT="GBUFFER"    bufIndex="1"   />

      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" stencilMode="disabled"/>
      <DrawGeometry type="InstanceMesh" class="Decal"    context="LIT_DEFER_INSTANCE"    order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="Decal"    context="LIT_DEFER"             order="STATECHANGES" />      

      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>


    <Stage id="Sunlight">
      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH" />

      <!--<ClearTarget colBuf0="true" depthBuf="false"  stencilBuf="false" col_R="0.0" col_G="1.0" col_B="0.0" col_A="0.0" />-->
      
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="GBUFFER"    bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="GBUFFER"    bufIndex="1"  />
      <BindBuffer sampler="gBuffer2Map"  sourceRT="GBUFFER"    bufIndex="2"  />
      <BindBuffer sampler="gBuffer3Map"  sourceRT="GBUFFER"    bufIndex="3"  />
      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF"  bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" stencilMode="maskReadInvert" depthTest="always" />
      
      <DrawQuad material="materials/Light.material.mbin" context="SUNLIGHT" />
      <SetContext stencilMode="disabled" />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>


    <!-- POSTPROCESS 
    <Stage id="PostProcess">


      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH" />

      <ColourMask channels="RGBA"/>
      <ClearTarget colBuf0="true" depthBuf="false"  stencilBuf="false" col_R="0.0" col_G="1.0" col_B="0.0" col_A="0.0" />


      <BindBuffer sampler="gBufferMap"   sourceRT="HDRBUF_0"   bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="GBUFFER"    bufIndex="1"  />
      <BindBuffer sampler="gBuffer2Map"  sourceRT="GBUFFER"    bufIndex="2"  />
      <BindBuffer sampler="gBuffer3Map"  sourceRT="GBUFFER"    bufIndex="3"  />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" stencilMode="maskReadInvert" depthTest="always" />
      <DrawQuad material="materials/Light.material.mbin" context="POSTPROCESS" />

      <SetContext stencilMode="disabled" />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage> -->
    
    <Stage id="Spotlights">
      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH" />

      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="GBUFFER"    bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="GBUFFER"    bufIndex="1"  />
      <BindBuffer sampler="gBuffer2Map"  sourceRT="GBUFFER"    bufIndex="2"  />
      <BindBuffer sampler="gBuffer3Map"  sourceRT="GBUFFER"    bufIndex="3"  />
      
      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF"  bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />

      <SetContext zwrite="false" colourWrite="true" cullMode="front" blendMode="add"    stencilMode="maskReadInvert" depthTest="greaterEqual" />
      <DoDeferredLightLoop context="SPOTLIGHT_INNER" inner="true"/>

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add"    stencilMode="maskReadInvert" depthTest="less" />
      <DoDeferredLightLoop context="SPOTLIGHT_OUTER" inner="false"/>


      <SetContext stencilMode="disabled" />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="Sky">

      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH"/>
      <ColourMask channels="RGB"/>

      <!-- Space/Night Sky -->
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskRead"/>
      <DoForwardLightLoop type="Mesh" class="Sky" context="LIGHTING" order="BACK_TO_FRONT" />


      <EndTarget flushCB="false" flushDB="false" />

    </Stage>

    <Stage id="WaterFromAbove">
      
      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH"/>
      <ColourMask channels="RGB"/>
      
      <!-- Water -->
      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF"  bufIndex="32" />
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" stencilMode="disabled" />
      <DoForwardLightLoop type="Water" class="Translucent" context="LIGHTING" order="STATECHANGES" />
      <DoForwardLightLoop type="Water" class="Opaque" context="LIGHTING" order="STATECHANGES" />

      <EndTarget flushCB="false" flushDB="false" />
      
    </Stage>
    
    <Stage id="PlanetCloud">
      
      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH"/>
      <ColourMask channels="RGB"/>
      
       <!--Cloud sphere around planets--> 
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" />
      <DoForwardLightLoop type="Mesh" class="Atmosphere" context="CLOUDSHADOW" order="BACK_TO_FRONT" />
    
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="less" />
      <DoForwardLightLoop type="Mesh" class="Atmosphere" context="CLOUD" order="BACK_TO_FRONT" />
    
      <EndTarget flushCB="false" flushDB="false" />
      
    </Stage>

    <Stage id="CopyDepth">

      <BeginTarget target="DEPTH_DOWN" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="GBUFFER"    bufIndex="1"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />     
      <DrawQuad material="materials/PostProcess.material.mbin" context="DOWNSAMPLE_GBUFFERDEPTH" />
      <EndTarget flushCB="true" flushDB="false" />
      <UnbindBuffers />
      
    </Stage>

    <Stage id="Volumetrics">
   
      <BeginTarget target="VOLUME" />
      <ColourMask channels="RGBA"/>
      
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_DOWN" bufIndex="0" />    
      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF"  bufIndex="32" />

      <SetContext zwrite="false" colourWrite="true" stencilMode="disabled" depthTest="always" blendMode="replace" />
      <DrawQuad material="materials/Light.material.mbin" context="SCATTERING" />

      <SetContext zwrite="false" colourWrite="true" cullMode="front" stencilMode="disabled" depthTest="always" blendMode="add" />
      <DoForwardLightLoop type="Mesh" class="AtmosphereNear" context="SCATTER_MASK" order="FRONT_TO_BACK" />
      <SetContext cullMode="back"/>

      <!--<SetContext zwrite="false" colourWrite="true" stencilMode="disabled" depthTest="always" blendMode="add" />
      <DrawQuad material="materials/Light.material.mbin" context="RAYMARCH" />-->
      
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="BLUR1" />
      <BindBuffer sampler="gBufferMap"  sourceRT="VOLUME" bufIndex="0"   />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN"  bufIndex="0"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_H_GUASS" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />    
      
      <BeginTarget target="VOLUME" />
      <BindBuffer sampler="gBufferMap"  sourceRT="BLUR1"   bufIndex="0"   />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN"  bufIndex="0"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_V_GUASS" />
      <UnbindBuffers />  
      <EndTarget flushCB="true" flushDB="false" />  
      
      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH"/>
      <ColourMask channels="RGB"/>
           
      <BindBuffer sampler="gBufferMap"  sourceRT="VOLUME"        bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN"    bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="GBUFFER"       bufIndex="1" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.25" /> 
      <SetContext zwrite="false" blendMode="blend" colourWrite="true" stencilMode="disabled" depthTest="always" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="BILATERAL_UPSAMPLE" />
      <UnbindBuffers />

      <SetContext zwrite="false" colourWrite="true" cullMode="front" stencilMode="disabled" depthTest="lessEqual" blendMode="add" />
      <DoForwardLightLoop type="Mesh" class="Atmosphere" context="SCATTERING" order="FRONT_TO_BACK" />
      <SetContext cullMode="back"/>

      <!-- Starfield -->
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" stencilMode="maskRead" />
      <DrawGeometry type="PStream" class="Opaque"    context="PSTREAM_SYSTEM"    order="STATECHANGES" />
      
      <EndTarget flushCB="false" flushDB="false" />    

    </Stage>
    
    <Stage id="Warp">
      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH"/>
      <ColourMask channels="RGB"/>
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="blend" depthTest="less" />
      <DoForwardLightLoop type="Mesh"     class="Warp"       context="LIT_FORWARD"    order="STATECHANGES" />
      <EndTarget flushCB="false" flushDB="false" /> 

    </Stage>

    <Stage id="Clouds">      
      <BeginTarget target="CLOUDS" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="Materials/Cloud.material.mbin" context="RENDER" width ="1.0" height="1.0" />
      <EndTarget flushCB="true" flushDB="true" />
      
      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH"/>
      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="always" />
      <BindBuffer sampler="gBufferMap"     sourceRT="CLOUDS"     bufIndex="0" />
      <BindBuffer sampler="gCloudDepthMap" sourceRT="CLOUDS"     bufIndex="32" />
      <BindBuffer sampler="gDepthMap"      sourceRT="GBUFFER"    bufIndex="1" />
      <DrawQuad material="materials/Cloud.material.mbin" context="COPY" width ="1.0" height="1.0" />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="WaterFromBelow">
      
      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH"/>

      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gShadowMap"       sourceRT="SHADOWBUF"       bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />
      
      <!-- Water From Underneath -->
      <SetContext zwrite="true" colourWrite="true" cullMode="front" blendMode="blend" depthTest="less" />
      <DoForwardLightLoop type="Water" class="Translucent" context="LIGHTING" order="STATECHANGES" />
      <DoForwardLightLoop type="Water" class="LOD1" context="LOD1" order="STATECHANGES" />

      <EndTarget flushCB="true" flushDB="true" />

    </Stage>
    
    <Stage id="BlendedAbove">
      
      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH"/>

      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gShadowMap"       sourceRT="SHADOWBUF"       bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />

      <!-- Quads -->
      <SetContext zwrite="true" colourWrite="true" cullMode="front"  blendMode="blend" depthTest="less" />
      <DoForwardLightLoop type="QUAD"     class="Opaque"  context="LIGHTING"  order="STATECHANGES" />
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="blend" depthTest="less" />
      <DoForwardLightLoop type="QUAD"     class="Opaque"  context="LIGHTING"  order="STATECHANGES" />

      <!-- Lines -->
      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="add" depthTest="less" />
      <SetUniform material="Models/Effects/Lines/Line.material.mbin" uniform="gScanParamsCfg2Vec4" a ="0.2" b="0.3" c="0.0" d="0.7" />
      <DoForwardLightLoop type="LINE"     class="Opaque"  context="SUBSTANCES"  order="STATECHANGES" />

      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="add" depthTest="greaterEqual" />
      <SetUniform material="Models/Effects/Lines/Line.material.mbin" uniform="gScanParamsCfg2Vec4" a ="0.0" b="0.3" c="1.0" d="0.1" />
      <DoForwardLightLoop type="LINE"     class="Opaque"  context="SUBSTANCES"  order="STATECHANGES" />
      <ColourMask channels="RGB"/>

      <!-- player gun additive. has to be rendered before the laser so it can lay down the stencil.-->      
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="add" depthTest="less" stencilMode="maskWrite" stencilRef="3"/>
      <DrawGeometry type="Mesh"         class="GunAdditive"    context="LIT_FORWARD"             order="STATECHANGES" />
      

      <!-- Transparent Objects -->
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="less" />
      <DoForwardLightLoop type="Mesh"     class="Additive"    context="LIT_FORWARD" order="BACK_TO_FRONT" />
 
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" />
      <DoForwardLightLoop type="Mesh"     class="Translucent" context="LIT_FORWARD" order="BACK_TO_FRONT" />

      <!--<ClearTarget colBuf0="false" depthBuf="false" stencilBuf="true" />-->
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite" />
      <DoForwardLightLoop type="Mesh"     class="Highlight"            context="LIT_FORWARD" order="BACK_TO_FRONT" />
      <SetContext stencilMode="disabled" />

      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite"/>
      <DoForwardLightLoop type="Mesh"     class="HighlightDoubleSided" context="LIT_FORWARD" order="BACK_TO_FRONT" />
      <SetContext stencilMode="disabled" />

      <!-- Trails -->
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="less" />
      <DoForwardLightLoop type="Trail" class="Translucent" context="LIGHTING" order="STATECHANGES" />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="less" />
      <DoForwardLightLoop type="Trail" class="Additive" context="LIGHTING_ADD" order="STATECHANGES" />

      <!--Single Lines-->
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="blend" depthTest="less" /> 
      <DoForwardLightLoop type="SingleLine" class="Opaque" context="LIGHTING" order="STATECHANGES" />

      <!--Single Lines-->
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="blend" depthTest="less" />
      <DoForwardLightLoop type="SPEEDLINE" class="Opaque" context="LIGHTING" order="STATECHANGES" />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="less" />
      <DoForwardLightLoop type="SingleLine" class="Additive" context="LIGHTING" order="STATECHANGES" />

      <!-- Markers -->
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" />
      <DoForwardLightLoop type="Mesh" class="Map" context="SCREEN_MAP" order="BACK_TO_FRONT" />

      <!-- Glow Translucent RGB -->
      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="Blend_OutputAlpha" depthTest="less" />
      <DoForwardLightLoop type="Mesh"  class="GlowTranslucent" context="LIT_FORWARD" order="BACK_TO_FRONT" />
      
      <!-- player laser. has to be rendered before the stencil buffer is cleared -->
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" stencilMode="maskReadInvert" stencilRef="3"  />
      <DoForwardLightLoop type="SingleLine" class="PlayerGunLaser" context="LIGHTING" order="STATECHANGES" />      
      <DoForwardLightLoop type="SingleLine" class="PlayerGunLaserCore" context="LIGHTING" order="STATECHANGES" />      
       
      
      <EndTarget flushCB="false" flushDB="false" />

      <!-- Glow Translucent Alpha -->
      <BeginTarget target="GBUFFER" depthTarget="DEPTH" />    
      <ColourMask channels="A"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="Blend_OutputAlpha" depthTest="less" />
      <DoForwardLightLoop type="Mesh"  class="GlowTranslucent" context="LIT_FORWARD" order="BACK_TO_FRONT" />
      <EndTarget flushCB="true" flushDB="true" />


    </Stage>
    
    <Stage id="Particles">
      
      <!-- Depth Downsample for particles - note we can't use the current down-sample, since Water may have written to the real Depth Buffer -->
      
      <BeginTarget target="DEPTH_DOWN" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH"    bufIndex="32"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="DOWNSAMPLE_DEPTH" />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="PARTICLES" /> 
      <ColourMask channels="RGBA"/>

      <ClearTarget depthBuf="true" colBuf0="true" col_R="0.0" col_G="0.0" col_B="0.0" col_A="1.0"/>
      <!--PS4: default setting after ClearTarget equals RT0-RGBA, so no need to call ColourMask again-->
      <BindBuffer sampler="gDepthBuffer" sourceRT="DEPTH_DOWN" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="Blend_OutputOneMinusAlpha" depthTest="always" />

      <DoForwardLightLoop  type="EMITTER"  class="Translucent" context="TRANSLUCENT_SOFT" order="BACK_TO_FRONT"/>
      <DoForwardLightLoop  type="HEAVYAIR" class="Translucent" context="HEAVYAIR_SOFT" order="BACK_TO_FRONT"/>
      <UnbindBuffers />
      
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="HDRBUF_1"/>
      <ColourMask channels="RGB"/>
 
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="always" />

      <BindBuffer sampler="gBuffer1Map" sourceRT="PARTICLES"    bufIndex="0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="PARTICLE_BLEND" />
      <UnbindBuffers />

      <BindBuffer sampler="gDepthBuffer" sourceRT="DEPTH_DOWN" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="always" />
      <DoForwardLightLoop  type="EMITTER"  class="Additive" context="TRANSLUCENT_ADDITIVE" order="BACK_TO_FRONT"/>
      <DoForwardLightLoop  type="HEAVYAIR" class="Additive" context="HEAVYAIR_SOFT" order="BACK_TO_FRONT"/>

      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

    </Stage>



    <Stage id="3dLines">
      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH" />
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" stencilMode="disabled"/>
      <DrawGeometry type="LINERENDERER"  class="Opaque"   context="LINE3D"            order="STATECHANGES" />
      <EndTarget flushCB="true" flushDB="true" />
    </Stage>

    <Stage id="DepthOfFieldBlur_ToneMap">
      <ColourMask channels="RGBA"/>
      <BeginTarget target="FINAL_OR_DOF_TONEMAP" />
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH" bufIndex="32" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/DepthOfField.material.mbin" context="TONEMAP_DEPTH" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
   </Stage>
    
   <Stage id="DepthOfFieldBlur">
      <ColourMask channels="RGBA"/>
      <BeginTarget target="DOF_BLURBUF1" />
      <BindBuffer sampler="gBufferMap"  sourceRT="FINAL_OR_DOF_TONEMAP" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>     
      <DrawQuad material="materials/PostProcess.material.mbin" context="DOWNSAMPLE" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />             
     
      <BeginTarget target="DOF_BLURBUF2" />
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_BLURBUF1" bufIndex="0" />
      <SetUniform material="materials/DepthOfField.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="8.0" />
      <DrawQuad material="materials/DepthOfField.material.mbin" context="GUASS_DEPTH_9" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="DOF_BLURBUF1" />
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_BLURBUF2" bufIndex="0" />
      <SetUniform material="materials/DepthOfField.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="8.0" />
      <DrawQuad material="materials/DepthOfField.material.mbin" context="GUASS_DEPTH_9_DISCARD" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
      
      <BeginTarget target="DOF_BLURBUF2" />
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_BLURBUF1" bufIndex="0" />
      <SetUniform material="materials/DepthOfField.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="8.0" />
      <DrawQuad material="materials/DepthOfField.material.mbin" context="GUASS_DEPTH_9_DISCARD" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="DOF_BLURBUF1" />
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_BLURBUF2" bufIndex="0" />
      <SetUniform material="materials/DepthOfField.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="8.0" />
      <DrawQuad material="materials/DepthOfField.material.mbin" context="GUASS_DEPTH_9_DISCARD" />
      <UnbindBuffers />    
      <EndTarget flushCB="true" flushDB="false" />       
     
      <BeginTarget target="FINAL_OR_DOF_TONEMAP" />
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_BLURBUF1" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="always" alphaToCoverage="false"/>         
      <DrawQuad material="materials/DepthOfField.material.mbin" context="BLEND" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
     
    </Stage>
    
    <Stage id="Bloom">
                       
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <ColourMask channels="RGB"/> <!--necessary on PS4, otherwise RGBA is enabled after ClearTarget-->

      <BeginTarget target="BLOOM_BLURBUF1" />
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="GBUFFER"  bufIndex="0"  />
      <DrawQuad material="materials/PostProcess.material.mbin" context="BRIGHTPASS" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
           
      <!--Fill Buffer 1-->
      <BeginTarget target="BLOOM_BLURBUF2" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF1" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="BLUR_KAWASE" />
      <EndTarget flushCB="true" flushDB="false" />   
      
      <BeginTarget target="BLOOM_BLURBUF1" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF2" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="BLUR_KAWASE" />
      <EndTarget flushCB="true" flushDB="false" />   

      
      <BeginTarget target="BLOOM_BLURBUF2" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF1" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="2.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="BLUR_KAWASE" />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="BLOOM_BLURBUF1" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF2" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="3.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="BLUR_KAWASE" />
      <EndTarget flushCB="true" flushDB="false" />   

      <!--Fill Buffer 2-->
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" alphaToCoverage="false"/>

      <BeginTarget target="BLOOM_BLURBUF2" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF1" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="4.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="BLUR_KAWASE" />
      <EndTarget flushCB="true" flushDB="false" />   

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>

      <BeginTarget target="BLOOM_BLURBUF3" />
      <ClearTarget depthBuf="false" colBuf0="true" excludeX360="true" col_R="0.0" col_G="0.0" col_B="0.0" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF2" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="5.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="BLUR_KAWASE" />
      <EndTarget flushCB="true" flushDB="false" />   
      
      <BeginTarget target="BLOOM_BLURBUF2" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF3" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="6.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="BLUR_KAWASE" />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="BLOOM_BLURBUF3" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF2" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="7.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="BLUR_KAWASE" />
      <EndTarget flushCB="true" flushDB="false" />   

      <!--Fill Buffer 3-->
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" alphaToCoverage="false"/>

      <BeginTarget target="BLOOM_BLURBUF4" />
      <ClearTarget depthBuf="false" colBuf0="true" excludeX360="true" col_R="0.0" col_G="0.0" col_B="0.0" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF3" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="5.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9" />
      <EndTarget flushCB="true" flushDB="false" />   

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="always" alphaToCoverage="false"/>

      <BeginTarget target="BLOOM_BLURBUF3" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF4" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="5.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9" />
      <EndTarget flushCB="true" flushDB="false" />   

      <UnbindBuffers />
    </Stage>


    <Stage id="LensFlare">
      <ColourMask channels="RGB"/>

      <BeginTarget target="LENS_BLURBUF" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF2" bufIndex="0" />
      <!--<SetUniform material="materials/LensFlare.material.mbin" uniform="gThresholdParamsVec4" a="0.3" b="2.0" c="0.0" d="0.4" />-->
      <DrawQuad material="materials/LensFlare.material.mbin" context="BRIGHT" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
     
      <BeginTarget target="LENSFLAREBUF" />
      <BindBuffer sampler="gBufferMap" sourceRT="LENS_BLURBUF" bufIndex="0" />
      <DrawQuad material="materials/LensFlare.material.mbin" context="FEATURE" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="LENSFINAL_OR_UI_COMBINE_BUF" />
      <BindBuffer sampler="gBufferMap" sourceRT="LENSFLAREBUF" bufIndex="0" />
      <DrawQuad material="materials/LensFlare.material.mbin" context="COMBINE" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="UI">

      <BeginTarget target="LENSFINAL_OR_UI_COMBINE_BUF"/>
      <ClearTarget depthBuf="false" colBuf0="false" excludeX360="true" col_R="0.0" col_G="0.0" col_B="0.0" col_A="1.0" />
      <!--PS4: not sure about the colourmask we want to have here, but it would end up being RGBA atm-->

      <SetContext zwrite="true" colourWrite="true" cullMode="none"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <!--<BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_1"          bufIndex="0" /> -->
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH" bufIndex="32" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="FINAL_OR_DOF_TONEMAP"     bufIndex="0" sRGBRead="1" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="BLOOM_BLURBUF2"  bufIndex="0" sRGBRead="1" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="BLOOM_BLURBUF3"  bufIndex="0" sRGBRead="1" />
      <BindBuffer sampler="gBuffer4Map" sourceRT="LENSFINAL_OR_UI_COMBINE_BUF"       bufIndex="0" sRGBRead="1" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="ADDITION_4" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
            
      <ColourMask channels="RGBA"/>
      <BeginTarget target="FINAL_OR_DOF_TONEMAP"/>
      <ClearTarget depthBuf="false" colBuf0="false" col_R="0.0" col_G="0.0" col_B="0.0" col_A="1.0" />
        
      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap" sourceRT="LENSFINAL_OR_UI_COMBINE_BUF" bufIndex="0" />
      <DrawQuad material="Materials/UI.material.mbin" context="UI" width="1.0" height="1.0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="Combine">
      <ColourMask channels="RGBA"/>
      <BeginTarget target="LENSFINAL_OR_UI_COMBINE_BUF"/>
      <ClearTarget depthBuf="false" colBuf0="false" excludeX360="true" col_R="0.0" col_G="1.0" col_B="0.0" col_A="1.0" />
      
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap" sourceRT="FINAL_OR_DOF_TONEMAP"  bufIndex="0" sRGBRead="1" />
      <!-- <BindBuffer sampler="gBuffer1Map" sourceRT="HDRBUF_1"        bufIndex="32" /> -->
      <DrawQuad material="materials/PostProcess.material.mbin" context="COMBINE" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />



    </Stage>
    
    

    <!--<Stage id="Gamma">
      <SwitchTarget target="FINAL"/>

      <ColourMask channels="RGB"/>
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" stencilMode="disabled" />
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_1"  bufIndex="0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GAMMACORRECT" />
      <UnbindBuffers />

    </Stage>-->

    <Stage id="FXAA">
      <ColourMask channels="RGBA"/>
      <BeginTarget target=""/>
      
      <ClearTarget depthBuf="false" colBuf0="false" excludeX360="true" col_R="0.0" col_G="0.0" col_B="0.0" col_A="1.0" />
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" />

      <BindBuffer sampler="gBufferMap" sourceRT="LENSFINAL_OR_UI_COMBINE_BUF"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH" bufIndex="32" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="FXAA" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <!--<Stage id="Gamma">

      <SwitchTarget target="FINAL"/>
      <ClearTarget depthBuf="true" colBuf0="true" excludeX360="true" col_R="0.0" col_G="0.0" col_B="0.0" col_A="1.0" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      --><!--<BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_1"          bufIndex="0" />--><!--
      <BindBuffer sampler="gBuffer1Map" sourceRT="DOF_BLURBUF1"    bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="BLOOM_BLURBUF_2xB"  bufIndex="0" />
      --><!--<BindBuffer sampler="gBuffer3Map" sourceRT="BLOOM_BLURBUF_8xB"  bufIndex="0" />
      <BindBuffer sampler="gBuffer4Map" sourceRT="BLOOM_BLURBUF_16xB"       bufIndex="0" />--><!--
      <DrawQuad material="materials/PostProcess.material.mbin" context="ADDITION_2" />
      <UnbindBuffers />
      
      --><!--<SwitchTarget target="FINAL"/>

      <ColourMask channels="RGB"/>
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" stencilMode="disabled" />
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_0"  bufIndex="0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GAMMACORRECT" />
      <UnbindBuffers />--><!--

    </Stage>-->

    <!--<Stage id="Debug">
      <SwitchTarget target=""/>

      <ColourMask channels="RGB"/>
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" stencilMode="disabled" />
      <BindBuffer sampler="gBufferMap"  sourceRT="FINAL"       bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="VOLUME"      bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="SCATTERING"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="HDRBUF_1"    bufIndex="0" />
      <DrawQuad material="materials/Debug.material.mbin" context="QUAD_SPLIT" />
      <UnbindBuffers />

    </Stage>
 
       <ColourMask channels="RGBA"/>

      <BeginTarget target="" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="SHADOWBUF" bufIndex="32" />
      <DrawQuad material="Materials/Debug.material.mbin" context="SHADOW" width ="0.5" height="0.5" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>  -->

    
    
    <Stage id="Reset States">
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="disabled" />
      <ColourMask channels="RGBA"/>
    </Stage>

  </CommandQueue>

</Pipeline>
